<div class="container pt-4 h-100">
  <div ngbAccordion>
    <div ngbAccordionItem>
      <h2 ngbAccordionHeader>
        <button ngbAccordionButton>About this Program</button>
      </h2>
      <div ngbAccordionCollapse>
        <div ngbAccordionBody>
          <ng-template>
            <h2>CYOA Downloader</h2>
            <p>
              When pointed to the root of an interactive cyoa, this app
              downloads the project.json file, fetches all images in the
              project.json, and embeds them in the project.json as data URLs. It
              also downloads javascript, css, and html files in the CYOA and
              optionally compresses the images in the CYOA to AVIF. The
              resulting zip file should include everything you need to rehost
              the cyoa elsewhere, including the exact same version of the viewer
              used by the cyoa, so it will look exactly the same as it does
              online.
            </p>
            <h4>Caveats</h4>
            <ul>
              <li>
                <del>
                  fetches and embeds images or compresses the images if the
                  project file is named project.json.</del
                >
              </li>
              <li>
                if the images are already embedded, it will download the json
                file and compress it, along with downloading the rest of the
                website.
              </li>
              <li>
                It probably won't work if the author used relative paths that
                are not relative to the site root.
              </li>
              <li>
                It assumes that javascript, font, and css files that have
                absolute urls are hosted on reliable CDNs and does not attempt
                to download them. This is usually a safe assumption, but might
                break things in the distant future.
              </li>
            </ul>
            <h3>2.0 Release</h3>
            <ul>
              <li>
                Now downloads the whole CYOA, not just the project.json file.
              </li>
              <li>Option to compress images.</li>
              <li>Option to save images as seperate files.</li>
              <li>Now embeds external URLs.</li>
              <li>
                Now saves some settings to localstorage. (Compress Images and
                Save Seperate Images).
              </li>
              <li>
                Project will now attempt to set the title of the downloaded zip
                archive using the following heuristic:
                <ol>
                  <li>A title manually input by the user.</li>
                  <li>The title of the first row in the project.json.</li>
                  <li>
                    The last path segment of the URL. ex:
                    bob.neocities.org/cyoas/<b>SomeCyoa</b>/
                  </li>
                  <li>
                    The subdomain of the URL. ex: <b>bobscyoa</b>.neocities.org
                  </li>
                  <li>cyoa.zip</li>
                </ol>
              </li>
            </ul>
            <h3>2.1 Release</h3>
            <ul>
              <li>Refactor code.</li>
              <li>Correct Mime Types if possible.</li>
              <li>Save Quality to localstorage.</li>
              <li>Default Quality is now 25, increased from 27.</li>
              <li>
                Rename Quality to cqLevel, as that is the acutal option in the
                AVIF library, and will hopefully reduce confusion about the
                setting.
              </li>
              <li>Remove unneeded SCSS code.</li>
              <li>
                Fixed bug where dataURLs in project.json were not saved as
                seperate images, only images fetched from external URLs were
                being saved as seperate images previously.
              </li>
            </ul>

            <h3>2.2 (unreleased)</h3>
            <ul>
              <li>Fix manual save name input.</li>
              <li>
                Handle routing redirects for project.json (ie ones that return
                index.html with a 200 response by checking response type).
              </li>
            </ul>
            <h3>2.3 Release</h3>
            <ul>
              <li>
                Now fetches json files with different names. If the project is
                embedded into the javascript file, it will fetch the javascript
                file, so the CYOA will work, but the other functionality of this
                app will not work (embedding external urls, compressing images
                etc)
              </li>
              <li>
                Fixed possible race condition where app did not wait for all
                files to be downloaded before processing JSON file.
              </li>
            </ul>

            <h3>2.3</h3>
            <ul>
              <li>
                Now fetches JSON files with different names. If the project is
                embedded into the javascript file, it will fetch the javascript
                file, so the CYOA will work, but the other functionality of this
                app will not work (embedding external urls, compressing images
                etc)
              </li>
              <li>
                Fixed possible race condition where app did not wait for all
                files to be downloaded before processing JSON file.
              </li>
            </ul>
            <h3>2.4</h3>
            <ul>
              <li>
                Fixed bug where the split project file was sorted after the
                sorting annotations were already removed, resulting in the
                project file being joined together in random order.
              </li>
              <li>
                Fix for Content-Type header of project file being returned with
                charset as well as mime type.
              </li>
            </ul>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <div class="my-4">
    <label for="cyoaURL" class="visually-hidden">URL to CYOA:</label>
    <div class="input-group">
      <div class="input-group-text w-20">URL to CYOA:</div>
      <input
        type="text"
        class="form-control"
        id="cyoaURL"
        [(ngModel)]="cyoaURLString"
      />
    </div>
  </div>
  <div class="my-4">
    <label for="cyoaURL" class="visually-hidden">CYOA Save Name:</label>
    <div class="input-group">
      <div class="input-group-text w-20">Save Name:</div>
      <input
        type="text"
        class="form-control"
        id="cyoaURL"
        [(ngModel)]="saveTitle"
      />
    </div>
  </div>

  @if (inProgress) {
  <ngb-progressbar
    class="mb-3"
    [showValue]="true"
    type="primary"
    [value]="progress"
    [max]="progressMax"
  />
  @if (doCompression) {
  <ngb-progressbar
    class="mb-3"
    [showValue]="true"
    type="info"
    [value]="AVIFprogress"
    [max]="AVIFprogressMax"
  />
  } }
  <ng-template #qualityTip class="qualityTip">
    lower values mean higher quality; try small changes to start
  </ng-template>
  <div class="mb-3 flex">
    <label for="quality" class="form-label">cqLevel: {{ quality }}</label>
    <input
      type="range"
      id="volume"
      class="form-range"
      name="quality"
      min="0"
      max="63"
      [ngbTooltip]="qualityTip"
      tooltipClass="my-custom-class"
      #qualitySlider
      [value]="quality"
      (input)="setQuality(qualitySlider.value)"
    />
  </div>
  <div class="d-flex justify-content-between">
    <button type="button" class="btn my-button mb-3" (click)="setQuality('25')">
      Reset Quality
    </button>
    <button type="button" class="btn my-button mb-3" (click)="resetURL()">
      Clear URL
    </button>
  </div>
  <div class="form-check">
    <input
      class="form-check-input"
      type="checkbox"
      [(ngModel)]="doCompression"
      (ngModelChange)="setDoCompression($event)"
      id="doCompression"
      checked
    />
    <label class="form-check-label" for="doCompression">
      Compress JSON File?
    </label>
  </div>
  <div class="form-check">
    <input
      class="form-check-input"
      type="checkbox"
      [(ngModel)]="shouldSaveSeperateFiles"
      (ngModelChange)="setSaveSeperateFiles($event)"
      id="shouldSaveSeperateFiles"
      checked
    />
    <label class="form-check-label" for="shouldSaveSeperateFiles">
      Save Seperate Images?
    </label>
  </div>

  <div class="my-4">
    <button type="submit" class="btn btn-primary" (click)="process()">
      Submit
    </button>
  </div>

  @if (result && result.href && result.download) {
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th scope="col">Download</th>
          <th scope="col">project.json Input Size</th>
          <th scope="col">project.json Output Size</th>
          <th scope="col">project.json Compressed Size</th>
          <th scope="col">Total CYOA Size</th>
          <th scope="col">Elapsed Time</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>
            <a href="{{ result.href }}" download="{{ result.download }}">{{
              result.download
            }}</a>
          </td>
          <td>{{ result.jsonInFileSize }}</td>
          <td>{{ result.jsonOutFileSize }}</td>
          <td>{{ result.jsonCompressedSize }}</td>
          <td>{{ result.cyoaTotalSize }}</td>
          <td>
            <time
              dateTime="PT{{ stripLeadingZeros(elapsedTime.split(':')[0]) }}H{{
                stripLeadingZeros(elapsedTime.split(':')[1])
              }}M{{
                stripLeadingZeros(elapsedTime.split(':')[2].split('.')[0])
              }}S"
              >{{ elapsedTime }}</time
            >
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  }
</div>
